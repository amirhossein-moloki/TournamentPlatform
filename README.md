# پلتفرم مسابقات

یک پلتفرم مسابقات جامع، امن و مقیاس‌پذیر که با Node.js، Express، PostgreSQL، Redis، RabbitMQ و Socket.io ساخته شده است. این پلتفرم از ثبت‌نام کاربر، مدیریت کیف پول، ایجاد و شرکت در مسابقات، به‌روزرسانی آنی مسابقات و گزارش‌دهی امن نتایج پشتیبانی می‌کند.

## فهرست مطالب

- [ویژگی‌ها](#ویژگیها)
- [اصول معماری](#اصول-معماری)
- [پشته فناوری](#پشته-فناوری)
- [ساختار پروژه](#ساختار-پروژه)
- [پیش‌نیازها](#پیشنیازها)
- [شروع به کار](#شروع-به-کار)
  - [نصب](#نصب)
  - [پیکربندی محیط](#پیکربندی-محیط)
  - [راه‌اندازی پایگاه داده](#راهاندازی-پایگاه-داده)
  - [اجرای برنامه](#اجرای-برنامه)
- [Endpointهای API](#endpointهای-api)
- [رویدادهای WebSocket](#رویدادهای-websocket)
- [اسکریپت‌ها](#اسکریپتها)
- [CI/CD](#cicd)
- [ملاحظات امنیتی](#ملاحظات-امنیتی)
- [مشارکت](#مشارکت)
- [مجوز](#مجوز)

## ویژگی‌ها

- **ثبت‌نام و احراز هویت امن**: مبتنی بر JWT (توکن‌های دسترسی و تازه‌سازی در کوکی‌های HttpOnly).
- **سیستم کیف پول**: شارژ با قابلیت idempotency، تاریخچه تراکنش‌ها، درخواست‌های برداشت امن.
- **مدیریت مسابقات**: ایجاد، لیست کردن، مشاهده جزئیات، ثبت‌نام و مدیریت مسابقات. مدیران مسابقات می‌توانند مسابقات مربوط به بازی‌هایی که به آنها اختصاص داده شده‌اند را مدیریت کنند.
- **مدیریت نقش پیشرفته**: پشتیبانی از نقش‌هایی مانند `PLAYER`, `ADMIN`, `TOURNAMENT_MANAGER`, `TOURNAMENT_SUPPORT`, `GENERAL_SUPPORT` برای کنترل دسترسی دقیق.
- **انواع مسابقات انعطاف‌پذیر**: پشتیبانی از انواع هزینه‌های ورودی (رایگان، نقدی، ارز درون بازی) و انواع جوایز (نقدی، فیزیکی، آیتم‌های درون بازی).
- **تشکیل و هماهنگی تیم**: (مفهومی - ساختار اولیه برای اتاق‌ها).
- **به‌روزرسانی آنی مسابقات و چت**: به‌روزرسانی زنده براکت از طریق Socket.io. زیرساخت برای یک سیستم چت جامع آنی بین کاربران و کارکنان پشتیبانی (پشتیبانی مسابقات، پشتیبانی عمومی) با موجودیت‌های جدید ChatSession و ChatMessage فراهم شده است.
- **گزارش‌دهی امن نتایج**: URLهای امضا شده برای آپلود اسکرین‌شات، اسکن ناهمزمان بدافزار.
- **حل اختلاف**: پنل ادمین برای مدیران.
- **پرداخت جوایز**: پردازش ناهمزمان از طریق صف پیام.
- **لیدر بوردها**: ارائه شده از یک پایگاه داده بهینه‌سازی شده برای خواندن (مانند Redis).
- **پنل ادمین**: دسترسی مبتنی بر نقش برای مدیریت کاربران، نقش‌ها، اختلافات و برداشت‌ها.

## اصول معماری

- **هماهنگی رویداد محور**: سرویس‌های جدا شده با استفاده از یک باس پیام (RabbitMQ).
- **معماری پاک**: جداسازی لایه‌های دامنه، برنامه و زیرساخت.
- **امنیت در طراحی**: امنیت در تمام مراحل توسعه یکپارچه شده است.

## پشته فناوری

- **بک‌اند**: Node.js, Express.js
- **پایگاه داده**: PostgreSQL (با Sequelize ORM)
- **کش**: Redis
- **صف پیام**: RabbitMQ (amqplib)
- **وب‌سوکت**: Socket.io
- **احراز هویت**: JSON Web Tokens (jsonwebtoken), bcryptjs
- **اعتبارسنجی**: Joi
- **لاگ‌گیری**: Winston
- **کانتینرسازی**: Docker, Docker Compose
- **CI/CD**: GitHub Actions
- **تست**: Jest, Supertest
- **لینتر/فرمتتر**: ESLint, Prettier

## ساختار پروژه

پروژه از الگوی معماری پاک پیروی می‌کند:

```
/tournament-platform
├── config/         # پیکربندی‌های محیط و برنامه
├── db/             # مایگریشن‌ها و سیدرهای پایگاه داده
├── docs/           # مستندات API (مانند مشخصات OpenAPI)
├── src/
│   ├── application/  # موارد استفاده، منطق خاص برنامه
│   ├── domain/       # منطق کسب‌وکار اصلی، موجودیت‌ها، رابط‌های ریپازیتوری
│   │   └── chat/     # موجودیت‌های سیستم چت (ChatSession, ChatMessage)
│   ├── infrastructure/ # اتصالات پایگاه داده، آداپتورهای سرویس خارجی (کش، پیام‌رسانی)
│   ├── presentation/   # مسیرهای API، کنترل‌کننده‌های WebSocket، کنترل‌کننده‌های وب‌هوک
│   ├── middleware/   # میان‌افزارهای Express (احراز هویت، مدیریت خطا، RBAC)
│   ├── workers/      # پردازنده‌های کارهای پس‌زمینه (مصرف‌کنندگان RabbitMQ)
│   ├── utils/        # ابزارهای مشترک (لاگر، کلاس‌های پاسخ/خطای API)
│   └── app.js        # راه‌اندازی برنامه Express
├── tests/          # تست‌های واحد، یکپارچه‌سازی، e2e، قرارداد، عملکرد
├── .github/        # گردش‌های کاری GitHub Actions
├── .dockerignore
├── .env.example
├── .eslintrc.js
├── .gitignore
├── .prettierrc
├── docker-compose.yml
├── Dockerfile
├── jsconfig.json
├── package.json
└── server.js       # نقطه ورود اصلی برنامه
```

## پیش‌نیازها

- [Node.js](https://nodejs.org/) (نسخه مشخص شده در `package.json` engines)
- [npm](https://www.npmjs.com/) یا [Yarn](https://yarnpkg.com/)
- [Docker](https://www.docker.com/get-started) و [Docker Compose](https://docs.docker.com/compose/install/) (برای راه‌اندازی کانتینری)
- [PostgreSQL](https://www.postgresql.org/download/) (در صورت اجرا به صورت محلی بدون Docker)
- [Redis](https://redis.io/download) (در صورت اجرا به صورت محلی بدون Docker)
- [RabbitMQ](https://www.rabbitmq.com/download.html) (در صورت اجرا به صورت محلی بدون Docker)

## شروع به کار

### نصب

۱.  **کلون کردن ریپازیتوری:**
    ```bash
    git clone <repository-url>
    cd tournament-platform
    ```

۲.  **نصب وابستگی‌ها:**
    ```bash
    npm install
    # یا
    # yarn install
    ```

### پیکربندی محیط

۱.  **ایجاد یک فایل `.env`** با کپی کردن از نمونه:
    ```bash
    cp .env.example .env
    ```
۲.  **به‌روزرسانی فایل `.env`** با پیکربندی‌های خاص خود برای:
    - برنامه (PORT, API_BASE_URL)
    - پایگاه داده (DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME)
    - JWT (JWT_SECRET, انقضای توکن)
    - Redis (REDIS_HOST, REDIS_PORT, REDIS_PASSWORD)
    - RabbitMQ (RABBITMQ_URL, نام صف‌ها)
    - درگاه پرداخت (API_KEY, WEBHOOK_SECRET) - توجه: این ممکن است برای یک درگاه عمومی باشد.
    - **درگاه پرداخت زرین‌پال**:
        - `ZARINPAL_MERCHANT_ID`: کد مرچنت زرین‌پال شما.
        - `ZARINPAL_ACCESS_TOKEN` (اختیاری): توکن دسترسی زرین‌پال شما، در صورت استفاده از ویژگی‌هایی مانند بازپرداخت.
    - AWS S3 (ACCESS_KEY_ID, SECRET_ACCESS_KEY, REGION, BUCKET_NAME)
    - لاگ‌گیری (LOG_LEVEL, مسیرهای فایل)
    - سیدر کاربر ادمین (ADMIN_EMAIL, ADMIN_PASSWORD)

### راه‌اندازی پایگاه داده

**با استفاده از Docker (توصیه می‌شود):**
دستور `docker-compose up` به طور خودکار سرویس‌های PostgreSQL، Redis و RabbitMQ را راه‌اندازی می‌کند.

**اجرا به صورت محلی (بدون Docker):**
اطمینان حاصل کنید که نمونه‌های PostgreSQL، Redis و RabbitMQ در حال اجرا و در فایل `.env` شما پیکربندی شده‌اند.

**مایگریشن‌ها و سیدینگ:**
هنگامی که سرویس پایگاه داده در حال اجرا است (از طریق Docker یا به صورت محلی و پیکربندی شده):

۱.  **اجرای مایگریشن‌های پایگاه داده:**
    ```bash
    npm run db:migrate
    ```
۲.  **اجرای سیدرهای پایگاه داده (مثلاً برای ایجاد یک کاربر ادمین):**
    ```bash
    npm run db:seed
    ```

### اجرای برنامه

**با استفاده از Docker (توصیه می‌شود):**

۱.  **ساخت و شروع کانتینرها:**
    ```bash
    npm run docker:build # (اگر قبلاً ساخته نشده یا تغییراتی در Dockerfile ایجاد شده است)
    npm run docker:run
    ```
    برنامه در `http://localhost:<PORT>` (مثلاً `http://localhost:3000`) قابل دسترسی خواهد بود.

۲.  **مشاهده لاگ‌ها:**
    ```bash
    npm run docker:logs
    ```

۳.  **متوقف کردن کانتینرها:**
    ```bash
    npm run docker:stop
    ```

**اجرا به صورت محلی (بدون Docker):**

۱.  **شروع سرور توسعه:**
    ```bash
    npm run dev
    ```
۲.  **شروع سرور تولید:**
    ```bash
    npm start
    ```
    برنامه در `http://localhost:<PORT>` قابل دسترسی خواهد بود.

## Endpointهای API

API با استفاده از مشخصات OpenAPI 3.x.x مستند شده است. فایل تعریف در `docs/swagger-generated.json` قرار دارد.

هنگامی که برنامه در حال اجرا است، یک رابط کاربری تعاملی Swagger در Endpoint `/api-docs` (مثلاً `http://localhost:3000/api-docs`) در دسترس است. این رابط کاربری به شما امکان می‌دهد API را کاوش کنید، جزئیات Endpoint را مشاهده کنید و آنها را مستقیماً در مرورگر خود آزمایش کنید.

فایل `server.js` برای بارگیری `docs/swagger-generated.json` و ارائه آن با استفاده از `swagger-ui-express` پیکربندی شده است.

دسته‌بندی‌های کلیدی Endpointها عبارتند از:

- **احراز هویت**: Endpointهای ثبت‌نام کاربر، ورود، تازه‌سازی توکن، خروج و تأیید ایمیل.
- **کاربران و ادمین**: مدیریت پروفایل کاربر (شخصی و ادمین)، لیست کاربران (ادمین)، تخصیص نقش (ادمین).
- **بازی‌ها**: عملیات CRUD برای بازی‌ها (ادمین).
- **مسابقات**: لیست عمومی و جزئیات، ثبت‌نام. ایجاد و مدیریت مسابقات توسط مدیران مسابقات مجاز و ادمین‌ها.
- **مسابقات**: ارسال نتایج، دریافت جزئیات مسابقه.
- **لیدر بوردها**: دریافت لیدر بوردهای بازی و رتبه‌های کاربران.
- **کیف پول**: شروع واریز، تاریخچه تراکنش‌ها، درخواست‌های برداشت. مدیریت برداشت‌ها توسط ادمین.
- **ادمین**: مدیریت اختلافات، تأیید/رد برداشت‌ها، مدیریت کاربران، مدیریت نقش.

برای مشخصات دقیق Endpointها، به رابط کاربری تعاملی Swagger مراجعه کنید.

## رویدادهای WebSocket

ارتباط امن WebSocket از طریق Socket.io مدیریت می‌شود. رویدادهای کلیدی در `SOCKET_IO_DOCUMENTATION.md` به تفصیل شرح داده شده‌اند.
این پلتفرم شامل موجودیت‌های بنیادی (`ChatSession`, `ChatMessage`) برای یک سیستم چت آنی جامع آینده است. این بخش با پیاده‌سازی کامل ویژگی چت به‌روز خواهد شد. رویدادهای مفهومی موجود:

| جهت                | نام رویداد     | توضیحات                                                                                                  |
| :----------------- | :------------- | :------------------------------------------------------------------------------------------------------- |
| **اتصال**          | `connection`   | احراز هویت با توکن دسترسی در حین handshake.                                                              |
| **کلاینت -> سرور**   | `joinRoom`     | درخواست برای پیوستن به یک اتاق چت خاص (سرور مجوز را بررسی می‌کند).                                       |
| **کلاینت -> سرور**   | `sendMessage`  | ارسال یک پیام (با محدودیت نرخ).                                                                           |
| **سرور -> کلاینت**   | `newMessage`   | پخش پیام پاک‌سازی شده به شرکت‌کنندگان اتاق.                                                               |
| **سرور -> کلاینت**   | `notification` | ارسال یک اعلان شخصی به یک کاربر.                                                                         |
| **سرور -> کلاینت**   | `bracketUpdate`| ارسال به‌روزرسانی‌های زنده براکت مسابقات.                                                                 |

## اسکریپت‌ها

- `npm start`: شروع برنامه در حالت تولید.
- `npm run dev`: شروع برنامه در حالت توسعه با Nodemon.
- `npm run lint`: لینت کردن کدبیس با ESLint.
- `npm run format`: فرمت کردن کد با Prettier.
- `npm test`: اجرای همه تست‌ها (واحد، یکپارچه‌سازی و غیره) با Jest.
- `npm run test:unit`, `npm run test:integration`, و غیره: اجرای انواع خاصی از تست‌ها.
- `npm run db:migrate`: اعمال مایگریشن‌های پایگاه داده.
- `npm run db:seed`: سیدینگ پایگاه داده.
- `npm run docker:build`: ساخت ایمیج Docker.
- `npm run docker:run`: شروع سرویس‌ها با Docker Compose.
- `npm run docker:stop`: متوقف کردن سرویس‌ها با Docker Compose.
- `npm run docker:logs`: دنبال کردن لاگ‌های کانتینر برنامه.

## تست

پروژه از [Jest](https://jestjs.io/) به عنوان فریم‌ورک تست خود استفاده می‌کند. تست‌ها به دسته‌های واحد، یکپارچه‌سازی و به طور بالقوه انواع دیگر (E2E، قرارداد، عملکرد) تقسیم می‌شوند.

**اجرای تست‌ها:**

*   **اجرای همه تست‌ها (واحد، یکپارچه‌سازی و غیره) و تولید گزارش پوشش:**
    ```bash
    npm test
    ```
*   **اجرای فقط تست‌های واحد:**
    ```bash
    npm run test:unit
    ```
    تست‌های واحد معمولاً در `tests/unit/` قرار دارند و بر روی ماژول‌ها یا توابع فردی به صورت مجزا، با وابستگی‌های mock شده، تمرکز دارند.
*   **اجرای فقط تست‌های یکپارچه‌سازی:**
    ```bash
    npm run test:integration
    ```
    تست‌های یکپارچه‌سازی در `tests/integration/` قرار دارند و تعامل بین اجزای مختلف، مانند Endpointهای API یا سرویس‌ها با لایه‌های پایگاه داده را آزمایش می‌کنند. این تست‌ها ممکن است به یک پایگاه داده تست در حال اجرا (همانطور که در `.env.test` پیکربندی شده) نیاز داشته باشند.
*   **اجرای یک فایل یا مجموعه تست خاص:**
    می‌توانید یک مسیر یا الگو را از طریق اسکریپت‌های npm به Jest ارسال کنید:
    ```bash
    # مثال: اجرای همه تست‌ها در یک دایرکتوری خاص
    npm test -- tests/unit/domain/
    # مثال: اجرای یک فایل تست واحد
    npm test -- tests/integration/auth.routes.test.js
    # مثال: اجرای تست‌های مطابق با یک نام خاص (با استفاده از فلگ -t Jest)
    npm test -- -t "should register a user"
    ```
    به `--` قبل از ارسال آرگومان‌های خاص Jest هنگام استفاده از `npm test` توجه کنید. برای اسکریپت‌های خاص مانند `npm run test:unit`، اغلب می‌توانید مسیر را مستقیماً اضافه کنید:
    ```bash
    npm run test:unit tests/unit/domain/user/user.entity.test.js
    ```

**محیط تست:**

*   اطمینان حاصل کنید که یک فایل `.env.test` پیکربندی شده دارید، به ویژه برای جزئیات اتصال پایگاه داده برای تست‌های یکپارچه‌سازی. این فایل معمولاً از `.env.example` کپی و سفارشی می‌شود.
*   `NODE_ENV=test` به طور خودکار توسط اسکریپت‌های تست تنظیم می‌شود، که ممکن است رفتار برنامه را تغییر دهد (مثلاً سطح لاگ‌گیری، پایگاه داده مورد استفاده).

**پوشش:**

*   دستور `npm test` به طور خودکار یک گزارش پوشش در دایرکتوری `coverage/` تولید می‌کند. می‌توانید `coverage/lcov-report/index.html` را در یک مرورگر باز کنید تا آمار دقیق پوشش را مشاهده کنید.

## CI/CD

پروژه از GitHub Actions برای یکپارچه‌سازی مداوم و استقرار مداوم استفاده می‌کند. گردش کار (`.github/workflows/ci-cd.yml`) شامل موارد زیر است:
- لینتینگ و تست در push/pull requestها به `main` و `develop`.
- ساخت و push ایمیج‌های Docker به یک رجیستری کانتینر در pushها به `main` و `develop`.
- استقرار خودکار در یک محیط آزمایشی از شاخه `develop`.
- تأیید دستی برای استقرار در محیط تولید از شاخه `main`.

## ملاحظات امنیتی

- **احراز هویت**: JWT با توکن‌های دسترسی کوتاه‌مدت و توکن‌های تازه‌سازی HttpOnly.
- **مجوزدهی**: کنترل دسترسی مبتنی بر نقش (RBAC). نقش‌های جدید (`TOURNAMENT_MANAGER`, `TOURNAMENT_SUPPORT`, `GENERAL_SUPPORT`) دسترسی دقیق را تضمین می‌کنند. به عنوان مثال، مدیران مسابقات فقط می‌توانند مسابقات مربوط به بازی‌هایی که به آنها اختصاص داده شده‌اند و مسابقاتی که به صراحت مدیریت می‌کنند را مدیریت کنند.
- **اعتبارسنجی ورودی**: Joi برای اعتبارسنجی بدنه، پارامترها و کوئری درخواست.
- **جلوگیری از تزریق SQL**: Sequelize ORM پاک‌سازی کوئری را انجام می‌دهد.
- **جلوگیری از XSS**: کدگذاری خروجی متنی (اگرچه عمدتاً یک API است، در صورت ارائه HTML مراقب باشید).
- **حفاظت از CSRF**: معمولاً برای APIهای بی‌حالت که از توکن‌ها در هدر/بدنه استفاده می‌کنند، مشکلی نیست، اما اطمینان حاصل کنید که هیچ احراز هویت مبتنی بر جلسه مخلوط نشده باشد. کوکی‌های توکن تازه‌سازی باید `SameSite=Strict` یا `Lax` باشند.
- **هدرهای امن**: از میان‌افزار `helmet` استفاده می‌شود.
- **محدودیت نرخ**: برای Endpointهای حساس اعمال می‌شود.
- **آپلود امن فایل**: URLهای از پیش امضا شده برای آپلود مستقیم کلاینت به S3. اسکن ناهمزمان بدافزار.
- **امنیت وب‌هوک**: تأیید امضای دیجیتال برای وب‌هوک‌های ورودی.
- **مدیریت اسرار**: تمام اسرار از متغیرهای محیطی بارگیری می‌شوند (از طریق `.env` در توسعه، ارائه شده توسط پلتفرم در تولید).
- **لاگ‌گیری**: لاگ‌گیری جامع با پوشاندن/ناشناس‌سازی داده‌های حساس.
- **مدیریت وابستگی**: به‌روزرسانی منظم وابستگی‌ها و ممیزی برای آسیب‌پذیری‌ها.

## مشارکت

مشارکت‌ها پذیرفته می‌شوند! لطفاً این مراحل را دنبال کنید:
۱. ریپازیتوری را فورک کنید.
۲. یک شاخه جدید ایجاد کنید (`git checkout -b feature/your-feature-name`).
۳. تغییرات خود را ایجاد کنید.
۴. اطمینان حاصل کنید که تست‌ها با موفقیت انجام می‌شوند (`npm test`).
۵. تغییرات خود را کامیت کنید (`git commit -m 'Add some feature'`).
۶. به شاخه push کنید (`git push origin feature/your-feature-name`).
۷. یک Pull Request باز کنید.

لطفاً اطمینان حاصل کنید که کد شما به استانداردهای لینتینگ و قالب‌بندی پروژه پایبند است.

## مجوز

این پروژه تحت مجوز ISC است. برای جزئیات بیشتر به فایل `LICENSE` (در صورت وجود، یا در صورت عدم ایجاد فایل جداگانه، در اینجا مشخص کنید) مراجعه کنید.

---

*این README یک نمای کلی ارائه می‌دهد. جزئیات پیاده‌سازی خاص را می‌توان در کدبیس و مستندات مرتبط (`docs/openapi.yml`) یافت.*
