# مستندات API

این سند توضیحات دقیقی از REST API پلتفرم مسابقات ارائه می‌دهد.

## فهرست مطالب

- [اطلاعات عمومی](#اطلاعات-عمومی)
  - [URL پایه](#url-پایه)
  - [احراز هویت](#احراز-هویت)
  - [پاسخ‌های رایج](#پاسخهای-رایج)
- [Endpointهای API](#endpointهای-api)
  - [احراز هویت (Auth)](#احراز-هویت-auth)
  - [کاربران (Users)](#کاربران-users)
  - [ادمین (Admin)](#ادمین-admin)
  - [بازی‌ها (Games)](#بازیها-games)
  - [مسابقات (Tournaments)](#مسابقات-tournaments)
  - [مسابقات (Matches)](#مسابقات-matches)
  - [لیدربوردها (Leaderboards)](#لیدربوردها-leaderboards)
  - [کیف پول (Wallet)](#کیف-پول-wallet)
  - [چت (Chat)](#چت-chat)

---

## اطلاعات عمومی

### URL پایه

تمام Endpointهای API با پیشوند `/api/v1` شروع می‌شوند.
- **سرور توسعه**: `http://localhost:3000/api/v1`

### احراز هویت

بیشتر Endpointها برای احراز هویت به یک توکن `Bearer` نیاز دارند. توکن باید در هدر `Authorization` گنجانده شود.

- **هدر**: `Authorization: Bearer <YOUR_JWT_ACCESS_TOKEN>`

برخی از Endpointها، مانند `/auth/refresh`، به یک کوکی `HttpOnly` به نام `jid` که حاوی توکن تازه‌سازی است، متکی هستند.

### پاسخ‌های رایج

- **`400 Bad Request`**: درخواست ناقص است، که اغلب به دلیل خطاهای اعتبارسنجی رخ می‌دهد. بدنه پاسخ شامل جزئیات خواهد بود.
- **`401 Unauthorized`**: احراز هویت مورد نیاز است و ناموفق بوده یا ارائه نشده است.
- **`403 Forbidden`**: کاربر احراز هویت شده مجوزهای لازم برای انجام این عمل را ندارد.
- **`404 Not Found`**: منبع درخواستی یافت نشد.
- **`409 Conflict`**: درخواست به دلیل تداخل با وضعیت فعلی منبع (مثلاً ورودی تکراری) قابل تکمیل نیست.
- **`500 Internal Server Error`**: یک خطای غیرمنتظره در سرور رخ داده است.

---

## Endpointهای API

### احراز هویت (Auth)

Endpointهای مربوط به ثبت‌نام کاربر، ورود و مدیریت توکن.

#### `POST /auth/register`
- **خلاصه**: ثبت‌نام یک کاربر جدید.
- **توضیحات**: یک کاربر جدید را ثبت‌نام می‌کند، او را وارد سیستم می‌کند، یک توکن دسترسی در بدنه پاسخ ارائه می‌دهد و یک توکن تازه‌سازی را در کوکی HttpOnly تنظیم می‌کند.
- **بدنه درخواست**:
  - `username` (رشته، الزامی): نام کاربری مورد نظر.
  - `email` (رشته، الزامی): آدرس ایمیل کاربر.
  - `password` (رشته، الزامی): رمز عبور کاربر (حداقل ۸ کاراکتر).
- **پاسخ‌ها**:
  - `201 Created`: یک شیء `AuthResponse` حاوی پروفایل `user` و `accessToken` را برمی‌گرداند. کوکی توکن تازه‌سازی را تنظیم می‌کند.
  - `400 Bad Request`, `409 Conflict`, `500 Internal Server Error`.

#### `POST /auth/login`
- **خلاصه**: ورود یک کاربر موجود.
- **بدنه درخواست**:
  - `email` (رشته، الزامی): ایمیل کاربر.
  - `password` (رشته، الزامی): رمز عبور کاربر.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `AuthResponse` را برمی‌گرداند. کوکی توکن تازه‌سازی را تنظیم می‌کند.
  - `400 Bad Request`, `401 Unauthorized`, `500 Internal Server Error`.

#### `POST /auth/refresh`
- **خلاصه**: تازه‌سازی یک توکن دسترسی.
- **توضیحات**: از کوکی توکن تازه‌سازی `HttpOnly` (`jid`) برای تولید یک توکن دسترسی جدید استفاده می‌کند.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `RefreshTokenResponse` حاوی `accessToken` جدید را برمی‌گرداند. همچنین ممکن است در صورت فعال بودن چرخش، یک کوکی توکن تازه‌سازی جدید تنظیم کند.
  - `401 Unauthorized`, `500 Internal Server Error`.

#### `POST /auth/logout`
- **خلاصه**: خروج کاربر فعلی.
- **امنیت**: `bearerAuth` الزامی است.
- **پاسخ‌ها**:
  - `200 OK`: یک پیام موفقیت‌آمیز را برمی‌گرداند. کوکی توکن تازه‌سازی را پاک می‌کند.
  - `401 Unauthorized`, `500 Internal Server Error`.

#### `POST /auth/request-verification-email`
- **خلاصه**: درخواست یک لینک تأیید ایمیل جدید.
- **امنیت**: `bearerAuth` الزامی است.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `RequestVerificationEmailResponse` با یک پیام تأیید را برمی‌گرداند.
  - `401 Unauthorized`, `404 Not Found`, `500 Internal Server Error`.

#### `POST /auth/verify-email`
- **خلاصه**: تأیید ایمیل کاربر با استفاده از یک توکن.
- **بدنه درخواست**:
  - `token` (رشته، الزامی): توکن تأیید از ایمیل.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `VerifyEmailResponse` با یک پیام موفقیت‌آمیز و `userId` را برمی‌گرداند.
  - `400 Bad Request`, `500 Internal Server Error`.

### کاربران (Users)

Endpointهای مربوط به مدیریت پروفایل‌های کاربری.

#### `GET /users/me`
- **خلاصه**: دریافت پروفایل کاربر فعلی.
- **امنیت**: `bearerAuth` الزامی است.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `UserPublicProfile` را برمی‌گرداند.
  - `401 Unauthorized`, `404 Not Found`.

#### `PUT /users/me`
- **خلاصه**: به‌روزرسانی پروفایل کاربر فعلی.
- **امنیت**: `bearerAuth` الزامی است.
- **بدنه درخواست**:
  - `username` (رشته، اختیاری): نام کاربری جدید.
- **پاسخ‌ها**:
  - `200 OK`: شیء `UserPublicProfile` به‌روزرسانی شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`.

### ادمین (Admin)

Endpointهای فقط برای ادمین برای مدیریت پلتفرم.

#### `GET /users`
- **خلاصه**: دریافت لیست همه کاربران (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای کوئری**:
  - `page` (عدد صحیح، اختیاری)
  - `limit` (عدد صحیح، اختیاری)
  - `role` (رشته، اختیاری): فیلتر بر اساس نقش کاربر.
  - `isVerified` (بولی، اختیاری): فیلتر بر اساس وضعیت تأیید.
- **پاسخ‌ها**:
  - `200 OK`: یک لیست صفحه‌بندی شده از اشیاء `UserPublicProfile` را برمی‌گرداند.
  - `401 Unauthorized`, `403 Forbidden`.

#### `GET /users/{id}`
- **خلاصه**: دریافت یک کاربر خاص با شناسه (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه کاربر.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `UserPublicProfile` را برمی‌گرداند.
  - `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

#### `PUT /users/{id}`
- **خلاصه**: به‌روزرسانی یک کاربر با شناسه (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه کاربر.
- **بدنه درخواست**:
  - `username` (رشته، اختیاری)
  - `email` (رشته، اختیاری)
  - `roles` (آرایه‌ای از رشته‌ها، اختیاری)
  - `isVerified` (بولی، اختیاری)
- **پاسخ‌ها**:
  - `200 OK`: شیء `UserPublicProfile` به‌روزرسانی شده را برمی‌گرداند.
  - `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

#### `DELETE /users/{id}`
- **خلاصه**: حذف یک کاربر با شناسه (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه کاربر.
- **پاسخ‌ها**:
  - `200 OK`: یک پیام موفقیت‌آمیز را برمی‌گرداند.
  - `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

#### `POST /users/{id}/roles`
- **خلاصه**: اختصاص یک نقش به یک کاربر (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه کاربر.
- **بدنه درخواست**:
  - `role` (رشته، الزامی): نقشی که باید اختصاص داده شود.
- **پاسخ‌ها**:
  - `200 OK`: شیء `UserPublicProfile` به‌روزرسانی شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

#### `DELETE /users/{id}/roles/{role}`
- **خلاصه**: حذف یک نقش از یک کاربر (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه کاربر.
  - `role` (رشته، الزامی): نقشی که باید حذف شود.
- **پاسخ‌ها**:
  - `200 OK`: شیء `UserPublicProfile` به‌روزرسانی شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

### بازی‌ها (Games)

Endpointهای مربوط به مدیریت بازی‌ها، معمولاً محدود به ادمین‌ها.

#### `POST /games`
- **خلاصه**: ایجاد یک بازی جدید (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **بدنه درخواست**: یک شیء `Game`. برای جزئیات به بخش اسکیماها مراجعه کنید.
- **پاسخ‌ها**:
  - `201 Created`: شیء `Game` تازه ایجاد شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`.

#### `GET /games`
- **خلاصه**: دریافت لیست بازی‌ها.
- **پارامترهای کوئری**:
  - `page` (عدد صحیح، اختیاری)
  - `limit` (عدد صحیح، اختیاری)
  - `isActive` (بولی، اختیاری): فیلتر بر اساس وضعیت فعال بودن.
- **پاسخ‌ها**:
  - `200 OK`: یک لیست صفحه‌بندی شده از اشیاء `Game` را برمی‌گرداند.
  - `400 Bad Request`.

#### `GET /games/{id}`
- **خلاصه**: دریافت جزئیات بازی با شناسه.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه بازی.
- **پاسخ‌ها**:
  - `200 OK`: شیء `Game` را برمی‌گرداند.
  - `404 Not Found`.

#### `PUT /games/{id}`
- **خلاصه**: به‌روزرسانی یک بازی با شناسه (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه بازی.
- **بدنه درخواست**: یک شیء `Game` با فیلدهایی برای به‌روزرسانی.
- **پاسخ‌ها**:
  - `200 OK`: شیء `Game` به‌روزرسانی شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

#### `DELETE /games/{id}`
- **خلاصه**: حذف یک بازی با شناسه (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه بازی.
- **پاسخ‌ها**:
  - `200 OK`: یک پیام موفقیت‌آمیز را برمی‌گرداند.
  - `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

### مسابقات (Tournaments)

Endpointهای مربوط به ایجاد، مشاهده و تعامل با مسابقات.

#### `POST /tournaments`
- **خلاصه**: ایجاد یک مسابقه جدید (فقط ادمین).
- **امنیت**: `bearerAuth` و نقش `Admin` الزامی است.
- **بدنه درخواست**: یک شیء `TournamentCreationRequest`.
- **پاسخ‌ها**:
  - `201 Created`: شیء کامل `TournamentDetails` را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found` (اگر gameId وجود نداشته باشد).

#### `GET /tournaments`
- **خلاصه**: دریافت لیست مسابقات.
- **پارامترهای کوئری**:
  - `page` (عدد صحیح، اختیاری)
  - `limit` (عدد صحیح، اختیاری)
  - `status` (رشته، اختیاری): فیلتر بر اساس وضعیت (مثلاً `REGISTRATION_OPEN`, `ONGOING`).
  - `gameName` (رشته، اختیاری): فیلتر بر اساس نام بازی.
  - `sortBy` (رشته، اختیاری): فیلدی برای مرتب‌سازی (مثلاً `startDate`, `name`).
  - `sortOrder` (رشته، اختیاری): `ASC` یا `DESC`.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `PaginatedTournaments` را برمی‌گرداند.
  - `400 Bad Request`.

#### `GET /tournaments/{id}`
- **خلاصه**: دریافت جزئیات مسابقه با شناسه.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه مسابقه.
- **پارامترهای کوئری**:
  - `include` (رشته، اختیاری): لیستی از روابط برای شامل شدن با کاما جدا شده (مثلاً "participants,matches").
- **پاسخ‌ها**:
  - `200 OK`: شیء `TournamentDetails` را برمی‌گرداند.
  - `404 Not Found`.

#### `POST /tournaments/{id}/register`
- **خلاصه**: ثبت‌نام در یک مسابقه.
- **امنیت**: `bearerAuth` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه مسابقه.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `TournamentRegistrationResponse` را برمی‌گرداند.
  - `400 Bad Request` (مثلاً ثبت‌نام بسته است), `401 Unauthorized`, `403 Forbidden`, `404 Not Found`.

### مسابقات (Matches)

Endpointهای مربوط به مدیریت جزئیات و نتایج مسابقات.

#### `GET /matches/{id}`
- **خلاصه**: دریافت جزئیات مسابقه با شناسه.
- **امنیت**: `bearerAuth` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه مسابقه.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `Match` را برمی‌گرداند.
  - `401 Unauthorized`, `404 Not Found`, `500 Internal Server Error`.

#### `POST /matches/{id}/results/upload-url`
- **خلاصه**: دریافت URL از پیش امضا شده برای اسکرین‌شات نتیجه مسابقه.
- **امنیت**: `bearerAuth` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه مسابقه.
- **بدنه درخواست**:
  - `filename` (رشته، الزامی): مثلاً "result.jpg". باید png، jpg، jpeg یا gif باشد.
  - `contentType` (رشته، الزامی): مثلاً "image/jpeg".
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `UploadUrlResponse` با `uploadUrl` و `fileKey` را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.

#### `POST /matches/{id}/results`
- **خلاصه**: ارسال نتیجه مسابقه.
- **امنیت**: `bearerAuth` الزامی است.
- **پارامترهای مسیر**:
  - `id` (رشته، الزامی): شناسه مسابقه.
- **بدنه درخواست**:
  - `winningParticipantId` (رشته، الزامی، uuid): شناسه برنده.
  - `scoreParticipant1` (عدد صحیح، اختیاری)
  - `scoreParticipant2` (عدد صحیح، اختیاری)
  - `resultScreenshotFileKey` (رشته، الزامی): کلید فایل S3 از مرحله آپلود.
  - `comments` (رشته، اختیاری)
- **پاسخ‌ها**:
  - `200 OK`: شیء `Match` به‌روزرسانی شده را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `403 Forbidden`, `404 Not Found`, `500 Internal Server Error`.

### لیدربوردها (Leaderboards)

Endpointهای مربوط به بازیابی اطلاعات لیدربورد.

#### `GET /leaderboards`
- **خلاصه**: دریافت یک لیدربورد.
- **پارامترهای کوئری**:
  - `gameName` (رشته، الزامی)
  - `metric` (رشته، اختیاری، enum: `wins`, `score`, `rating`, `earnings`, پیش‌فرض: `rating`)
  - `period` (رشته، اختیاری، enum: `daily`, `weekly`, `monthly`, `all_time`, پیش‌فرض: `all_time`)
  - `page` (عدد صحیح، اختیاری)
  - `limit` (عدد صحیح، اختیاری)
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `LeaderboardResponse` حاوی ورودی‌های لیدربورد و جزئیات صفحه‌بندی را برمی‌گرداند.
  - `400 Bad Request`, `500 Internal Server Error`.

#### `GET /leaderboards/user/{userId}`
- **خلاصه**: دریافت رتبه کاربر در لیدربوردها.
- **پارامترهای مسیر**:
  - `userId` (رشته، الزامی، uuid)
- **پارامترهای کوئری**:
  - `gameName` (رشته، الزامی)
  - `metric` (رشته، اختیاری، enum: `wins`, `score`, `rating`, `earnings`, پیش‌فرض: `rating`)
  - `period` (رشته، اختیاری، enum: `daily`, `weekly`, `monthly`, `all_time`, پیش‌فرض: `all_time`)
  - `surroundingCount` (عدد صحیح، اختیاری، پیش‌فرض: ۵): تعداد ورودی‌هایی که باید بالا و پایین کاربر نمایش داده شوند.
- **پاسخ‌ها**:
  - `200 OK`: یک شیء `UserRankDetail` را برمی‌گرداند.
  - `400 Bad Request`, `404 Not Found`, `500 Internal Server Error`.

### کیف پول (Wallet)

Endpointهای مربوط به مدیریت کیف پول کاربران و تراکنش‌ها.

#### `GET /wallet`
- **خلاصه**: دریافت جزئیات کیف پول کاربر.
- **امنیت**: `bearerAuth` الزامی است.
- **پاسخ‌ها**:
  - `200 OK`: شیء `WalletDetailsResponse` را برمی‌گرداند.
  - `401 Unauthorized`, `404 Not Found`.

#### `POST /wallet/deposit/initialize`
- **خلاصه**: شروع یک واریز.
- **امنیت**: `bearerAuth` الزامی است.
- **هدرها**:
  - `X-Idempotency-Key` (رشته، الزامی، uuid)
- **بدنه درخواست**:
  - `amount` (عدد، الزامی، مثبت)
  - `currency` (رشته، الزامی، مثلاً "IRR", "USD")
- **پاسخ‌ها**:
  - `200 OK`: شیء `InitializeDepositResponse` با `paymentGatewayUrl` و `transactionId` را برمی‌گرداند.
  - `400 Bad Request`, `401 Unauthorized`, `409 Conflict` (idempotency).

#### `GET /wallet/history`
- **خلاصه**: دریافت تاریخچه تراکنش‌های کاربر.
- **امنیت**: `bearerAuth` الزامی است.
- **پارامترهای کوئری**:
  - `page` (عدد صحیح، اختیاری)
  - `limit` (عدد صحیح، اختیاری)
  - `type` (رشته، اختیاری، enum: `DEPOSIT`, `WITHDRAWAL`, و غیره)
  - `status` (رشته، اختیاری، enum: `PENDING`, `COMPLETED`, و غیره)
  - `sortBy` (رشته، اختیاری، enum: `transactionDate`, `amount`)
  - `sortOrder` (رشته، اختیاری، enum: `ASC`, `DESC`)
- **پاسخ‌ها**:
  - `200 OK`: شیء `PaginatedTransactionHistoryResponse` را برمی‌گرداند.
  - `401 Unauthorized`.

#### `POST /wallet/withdrawals`
- **خلاصه**: درخواست برداشت وجه.
- **امنیت**: `bearerAuth` الزامی است.
- **هدرها**:
  - `X-Idempotency-Key` (رشته، الزامی، uuid)
- **بدنه درخواست**:
  - `amount` (عدد، الزامی، مثبت)
  - `currency` (رشته، الزامی)
  - `withdrawalMethodDetails` (شیء، الزامی): جزئیات مربوط به روش برداشت انتخابی (مثلاً ایمیل PayPal، اطلاعات حساب بانکی).
- **پاسخ‌ها**:
  - `202 Accepted`: درخواست برداشت پذیرفته شد. `RequestWithdrawalResponse` را برمی‌گرداند.
  - `200 OK`: پخش مجدد Idempotent. `RequestWithdrawalResponse` را برمی‌گرداند.
  - `400 Bad Request` (مثلاً موجودی ناکافی), `401 Unauthorized`, `409 Conflict`.
